# Copyright (c) 2026 The Bitcoin Core developers
# Distributed under the MIT software license, see the accompanying
# file COPYING or https://opensource.org/license/mit.

name: Bitcoin Ownership Announcement

on:
  workflow_dispatch:
    inputs:
      announcement_type:
        description: 'Type of announcement to make'
        required: false
        default: 'ownership'
        type: choice
        options:
          - ownership
          - verification
          - status
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  push:
    branches:
      - master
    paths:
      - '.github/workflows/bitcoin-ownership-announcement.yml'

# Explicitly grant write permissions for the workflow
# to commit back to the repository
permissions:
  contents: write
  issues: write

concurrency:
  group: bitcoin-ownership-${{ github.ref }}
  cancel-in-progress: true

jobs:
  announce-ownership:
    name: 'Announce Bitcoin Ownership'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup environment
        run: |
          echo "WORKFLOW_RUN_TIME=$(date -u +%Y-%m-%d-%H-%M-%S)" >> $GITHUB_ENV
          echo "ANNOUNCEMENT_DATE=$(date -u +%Y-%m-%d)" >> $GITHUB_ENV

      - name: Create ownership announcement
        run: |
          echo "üì¢ Creating Bitcoin Ownership Announcement..."
          mkdir -p data/ownership

          # ENS Names (stored as plain text - public information)
          # These are Ethereum Name Service identifiers
          ENS_BASE="Kushmanmb.base.eth"
          ENS_MAINNET="kushmanmb.eth"

          # Create announcement document
          cat > data/ownership/announcement-${ANNOUNCEMENT_DATE}.md << EOF
          # Bitcoin Ownership Announcement

          **Date**: ${ANNOUNCEMENT_DATE}
          **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ## Ownership Declaration

          This repository announces Bitcoin ownership associated with the following
          Ethereum Name Service (ENS) identifiers:

          ### Primary ENS Names
          - **Base Network**: ${ENS_BASE}
          - **Ethereum Mainnet**: ${ENS_MAINNET}

          ### Important Notes

          ‚ö†Ô∏è **Security Notice**: This announcement does NOT contain:
          - Private keys
          - Seed phrases
          - Wallet passwords
          - Bitcoin addresses (unless explicitly added by owner)
          - Any sensitive cryptographic material

          ### Verification

          This announcement is made through GitHub Actions workflow and is
          cryptographically signed by the GitHub Actions system.

          - **Repository**: ${{ github.repository }}
          - **Workflow Run**: ${{ github.run_id }}
          - **Commit SHA**: ${{ github.sha }}
          - **Actor**: ${{ github.actor }}

          ### Purpose

          This announcement serves to:
          1. Publicly declare the association between the repository and ENS names
          2. Provide a verifiable, timestamped record of ownership claims
          3. Enable cross-chain identity verification

          ### Contact & Verification

          For verification queries or ownership challenges, please:
          1. Create a GitHub Issue in this repository
          2. Reference this announcement document
          3. Provide proof of your claim

          ---

          **Generated by**: GitHub Actions
          **Workflow**: bitcoin-ownership-announcement.yml
          **Automation Run**: ${{ github.run_number }}

          ## Disclaimer

          This announcement is for informational purposes only. It does not
          constitute financial advice, investment guidance, or a guarantee of
          asset control. Always verify ownership through appropriate cryptographic
          means (e.g., signed messages, on-chain transactions).

          ---

          *This is an automated announcement. For questions, open an issue.*
          EOF

          echo "‚úì Announcement created successfully"
          cat data/ownership/announcement-${ANNOUNCEMENT_DATE}.md

      - name: Create ownership index
        run: |
          echo "üìã Creating ownership index..."
          
          cat > data/ownership/README.md << 'EOF'
          # Bitcoin Ownership Announcements

          This directory contains timestamped announcements of Bitcoin ownership
          associated with ENS (Ethereum Name Service) identifiers.

          ## ENS Identifiers

          - **Kushmanmb.base.eth** - Base Network ENS
          - **kushmanmb.eth** - Ethereum Mainnet ENS

          ## Recent Announcements

          EOF

          # List all announcement files
          find data/ownership -name "announcement-*.md" -type f | sort -r | head -10 | while read -r file; do
            filename=$(basename "$file")
            echo "- [$filename]($filename)" >> data/ownership/README.md
          done

          echo "" >> data/ownership/README.md
          echo "---" >> data/ownership/README.md
          echo "Last updated: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" >> data/ownership/README.md

          echo "‚úì Index created"

      - name: Commit and push announcements
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/ownership/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            announcement_type="${{ github.event.inputs.announcement_type || 'ownership' }}"
            run_id="${{ github.run_id }}"
            
            git commit -m "chore: bitcoin ownership announcement [automated]

            - Announced at: ${WORKFLOW_RUN_TIME}
            - Type: ${announcement_type}
            - ENS: Kushmanmb.base.eth, kushmanmb.eth
            - Workflow run: ${run_id}

            This commit contains a timestamped announcement of Bitcoin
            ownership associated with the specified ENS names.
            No private keys or sensitive data are included."

            git push origin ${{ github.ref_name }}
            echo "‚úì Announcement committed and pushed"
          fi

      - name: Create workflow summary
        if: always()
        run: |
          announcement_type="${{ github.event.inputs.announcement_type || 'ownership' }}"
          summary="${GITHUB_STEP_SUMMARY}"
          
          echo "## Bitcoin Ownership Announcement Summary" >> "${summary}"
          echo "" >> "${summary}"
          echo "‚úÖ **Announcement Created Successfully**" >> "${summary}"
          echo "" >> "${summary}"
          echo "### Details" >> "${summary}"
          echo "- **Timestamp**: ${WORKFLOW_RUN_TIME}" >> "${summary}"
          echo "- **Type**: ${announcement_type}" >> "${summary}"
          echo "- **ENS Names**:" >> "${summary}"
          echo "  - Kushmanmb.base.eth" >> "${summary}"
          echo "  - kushmanmb.eth" >> "${summary}"
          echo "" >> "${summary}"
          echo "### Security" >> "${summary}"
          echo "üîí This announcement contains NO sensitive data:" >> "${summary}"
          echo "- ‚úÖ No private keys" >> "${summary}"
          echo "- ‚úÖ No seed phrases" >> "${summary}"
          echo "- ‚úÖ No wallet credentials" >> "${summary}"
          echo "- ‚úÖ Only public ENS identifiers" >> "${summary}"
          echo "" >> "${summary}"
          echo "### Files Created" >> "${summary}"
          echo "- \`data/ownership/announcement-${ANNOUNCEMENT_DATE}.md\`" >> "${summary}"
          echo "- \`data/ownership/README.md\`" >> "${summary}"
          echo "" >> "${summary}"
          echo "---" >> "${summary}"
          echo "*Workflow: bitcoin-ownership-announcement.yml*" >> "${summary}"

      - name: Upload announcement artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bitcoin-ownership-announcement-${{ env.WORKFLOW_RUN_TIME }}
          path: data/ownership/
          retention-days: 365  # Keep for one year

  verify-no-secrets:
    name: 'Verify No Secrets in Announcement'
    runs-on: ubuntu-latest
    needs: announce-ownership

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Security scan for secrets
        run: |
          echo "üîç Scanning for potential secrets in ownership announcements..."
          
          # Define patterns that should NOT be present
          FORBIDDEN_PATTERNS=(
            "private[_-]?key"
            "secret[_-]?key"
            "seed[_-]?phrase"
            "mnemonic"
            "password"
            "-----BEGIN.*PRIVATE KEY-----"
            "xprv"  # Bitcoin extended private key prefix
            "0x[0-9a-fA-F]{64}"  # Ethereum private key pattern
            "[5KL][1-9A-HJ-NP-Za-km-z]{50,51}"  # Bitcoin WIF private key
          )
          
          FOUND_ISSUES=0
          
          if [ -d data/ownership ]; then
            for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
              echo "Checking for pattern: $pattern"
              if grep -rniE "$pattern" data/ownership/ 2>/dev/null; then
                echo "‚ùå ERROR: Potential secret found matching pattern: $pattern"
                FOUND_ISSUES=$((FOUND_ISSUES + 1))
              fi
            done
          fi
          
          if [ $FOUND_ISSUES -gt 0 ]; then
            echo "‚ùå CRITICAL: Found $FOUND_ISSUES potential secrets in announcements!"
            echo "This is a security violation. Workflow must be fixed immediately."
            exit 1
          fi
          
          echo "‚úÖ Security scan passed - no secrets detected"

      - name: Verify ENS names only
        run: |
          echo "üîç Verifying only expected ENS names are present..."
          
          EXPECTED_ENS=(
            "Kushmanmb.base.eth"
            "kushmanmb.eth"
          )
          
          if [ -d data/ownership ]; then
            for ens in "${EXPECTED_ENS[@]}"; do
              if grep -r "$ens" data/ownership/ > /dev/null; then
                echo "‚úÖ Found expected ENS: $ens"
              else
                echo "‚ö†Ô∏è Warning: Expected ENS not found: $ens"
              fi
            done
          fi
          
          echo "‚úÖ ENS verification complete"

  create-summary:
    name: 'Create Summary Issue'
    runs-on: ubuntu-latest
    needs: [announce-ownership, verify-no-secrets]
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Create summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const body = `## Bitcoin Ownership Announcement Created
            
            üîî A new Bitcoin ownership announcement has been generated and committed.
            
            ### ENS Identifiers
            - **Kushmanmb.base.eth** (Base Network)
            - **kushmanmb.eth** (Ethereum Mainnet)
            
            ### Security Status
            ‚úÖ All security checks passed:
            - No private keys detected
            - No seed phrases detected
            - No sensitive credentials detected
            - Only public ENS identifiers included
            
            ### Verification
            - Workflow Run: [#${context.runNumber}](${runUrl})
            - Date: ${new Date().toISOString()}
            - Actor: @${context.actor}
            
            ### Files Updated
            - \`data/ownership/announcement-*.md\`
            - \`data/ownership/README.md\`
            
            ---
            
            *This is an automated announcement from the bitcoin-ownership-announcement workflow.*
            `;
            
            // Only create issue if manually triggered
            if (context.eventName === 'workflow_dispatch') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Bitcoin Ownership Announcement - ${new Date().toISOString().split('T')[0]}`,
                body: body,
                labels: ['announcement', 'bitcoin', 'ownership', 'automated']
              });
            }
