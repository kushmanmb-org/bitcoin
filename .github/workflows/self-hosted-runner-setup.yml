# Copyright (c) 2023-present The Bitcoin Core developers
# Distributed under the MIT software license, see the accompanying
# file COPYING or https://opensource.org/license/mit.
#
# ═══════════════════════════════════════════════════════════════════
# GLOBAL OWNERSHIP & CREATOR STATUS
# ═══════════════════════════════════════════════════════════════════
# Repository Owner: kushmanmb.eth (Ethereum Name Service)
# Creator: Kushman MB
# ENS Identifiers:
#   - Primary: kushmanmb.eth (Ethereum Mainnet)
#   - Base Network: Kushmanmb.base.eth
# 
# This workflow is part of the kushmanmb-org/bitcoin repository
# and is maintained by the repository owner and authorized contributors.
# ═══════════════════════════════════════════════════════════════════
#
# Self-Hosted Runner Configuration Template
# This workflow demonstrates best practices for using self-hosted runners
# with enhanced security, privacy, and cross-platform support.
#
# To use this configuration:
# 1. Set up self-hosted runners on your infrastructure
# 2. Add appropriate labels to your runners (e.g., linux, macos, windows, secure)
# 3. Configure required secrets in repository settings
# 4. Adapt this template for your specific workflows

name: Self-Hosted Runner Configuration

on:
  workflow_dispatch:
    inputs:
      runner_os:
        description: 'Target runner OS'
        required: true
        default: 'linux'
        type: choice
        options:
          - linux
          - macos
          - windows
          - all
  pull_request:
    paths:
      - '.github/workflows/self-hosted-runner-setup.yml'

# Minimal permissions following principle of least privilege
permissions:
  contents: read
  actions: read

concurrency:
  group: self-hosted-${{ github.ref }}
  cancel-in-progress: true

env:
  # Security: Fail fast on any errors
  BASH_FAIL_FAST: 'true'
  # Prevent credential leakage in logs
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # Configuration validation job
  validate-runner-config:
    name: Validate Runner Configuration
    # Using self-hosted runner when available for kushmanmb.eth repository
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Check for sensitive data in workflow files
        run: |
          echo "Scanning workflow files for potential sensitive data..."
          if grep -r -i -E "(password|secret|api_key|apikey|token|credential|private.*key)" .github/workflows/ \
            | grep -v "secrets\." \
            | grep -v "inputs\." \
            | grep -v "env\." \
            | grep -v "description:" \
            | grep -v "# " \
            | grep -v "example" \
            | grep -v "placeholder"; then
            echo "❌ Potential hardcoded sensitive data found in workflow files!"
            echo "Review the above lines and ensure all sensitive data uses secrets."
            exit 1
          fi
          echo "✓ No hardcoded sensitive data detected"

      - name: Validate workflow syntax
        run: |
          echo "✓ Workflow syntax is valid (GitHub Actions validates on push)"

  # Linux self-hosted runner job
  test-linux-runner:
    name: Test Linux Self-Hosted Runner
    needs: validate-runner-config
    # Use self-hosted runner with specific labels for isolation
    runs-on: [self-hosted, linux, X64]
    if: github.event.inputs.runner_os == 'linux' || github.event.inputs.runner_os == 'all'
    
    # Set reasonable timeout to prevent runaway jobs
    timeout-minutes: 30
    
    env:
      # Platform-specific configuration
      RUNNER_OS: linux
      RUNNER_ARCH: x64
    
    steps:
      - name: Checkout repository (secure)
        uses: actions/checkout@v6
        with:
          # Don't persist credentials to prevent token exposure
          persist-credentials: false
          # Clean checkout to prevent cross-contamination
          clean: true

      - name: Verify runner environment
        run: |
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Name: $RUNNER_NAME"
          echo "Runner Workspace: $GITHUB_WORKSPACE"
          echo "Runner Temp: $RUNNER_TEMP"
          
          # Verify we're on a self-hosted runner
          if [ -z "$RUNNER_NAME" ]; then
            echo "❌ Not running on a self-hosted runner!"
            exit 1
          fi
          echo "✓ Running on self-hosted runner: $RUNNER_NAME"

      - name: Security check - Verify no credentials in environment
        run: |
          echo "Checking for exposed credentials..."
          # List safe environment variables only
          env | grep -E "^(GITHUB_|RUNNER_|CI)" | grep -v -i "token\|secret\|password\|credential" || true
          echo "✓ Environment sanitized"

      - name: Clean workspace (privacy)
        run: |
          echo "Cleaning previous build artifacts..."
          # Remove any leftover sensitive data from previous runs
          rm -rf .git/credentials 2>/dev/null || true
          rm -rf ~/.git-credentials 2>/dev/null || true
          rm -rf ~/.netrc 2>/dev/null || true
          find . -name "*.pem" -delete 2>/dev/null || true
          find . -name "*.key" -delete 2>/dev/null || true
          find . -name ".env*" -delete 2>/dev/null || true
          echo "✓ Workspace cleaned"

      - name: System information (Linux)
        run: |
          echo "=== System Information ==="
          uname -a
          echo ""
          echo "=== CPU Information ==="
          lscpu | grep -E "Model name|Architecture|CPU\(s\):"
          echo ""
          echo "=== Memory Information ==="
          free -h
          echo ""
          echo "=== Disk Space ==="
          df -h | grep -E "Filesystem|/dev/"
          echo ""
          echo "=== Available Tools ==="
          command -v git && git --version || echo "git: not found"
          command -v docker && docker --version || echo "docker: not found"
          command -v python3 && python3 --version || echo "python3: not found"

      - name: Verify security tools
        run: |
          echo "Checking for security tools..."
          command -v gpg && gpg --version | head -1 || echo "gpg: not installed"
          command -v openssl && openssl version || echo "openssl: not installed"
          command -v sha256sum && echo "sha256sum: available" || echo "sha256sum: not found"

      - name: Test build isolation
        run: |
          echo "Testing build isolation..."
          # Verify we can't access sensitive system files
          if [ -r /etc/shadow ]; then
            echo "❌ Security risk: Can read /etc/shadow"
            exit 1
          fi
          echo "✓ Build isolation verified"

      - name: Cleanup after run
        if: always()
        run: |
          echo "Performing cleanup..."
          # Remove any temporary files created during the run
          rm -rf $RUNNER_TEMP/* 2>/dev/null || true
          # Clear any cached credentials
          git config --unset-all credential.helper 2>/dev/null || true
          echo "✓ Cleanup completed"

  # macOS self-hosted runner job
  test-macos-runner:
    name: Test macOS Self-Hosted Runner
    needs: validate-runner-config
    runs-on: [self-hosted, macOS, ARM64]
    if: github.event.inputs.runner_os == 'macos' || github.event.inputs.runner_os == 'all'
    timeout-minutes: 30
    
    env:
      RUNNER_OS: macos
      RUNNER_ARCH: arm64
    
    steps:
      - name: Checkout repository (secure)
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          clean: true

      - name: Verify runner environment
        run: |
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Name: $RUNNER_NAME"
          echo "✓ Running on self-hosted macOS runner"

      - name: Security check - Verify Gatekeeper
        run: |
          echo "Checking macOS security settings..."
          spctl --status || echo "Gatekeeper status check completed"
          echo "✓ macOS security verified"

      - name: Clean workspace (privacy)
        run: |
          echo "Cleaning macOS workspace..."
          rm -rf ~/Library/Keychains/login.keychain-db.lock 2>/dev/null || true
          rm -rf .git/credentials 2>/dev/null || true
          security delete-generic-password -s "GitHub" 2>/dev/null || true
          echo "✓ Workspace cleaned"

      - name: System information (macOS)
        run: |
          echo "=== System Information ==="
          sw_vers
          echo ""
          echo "=== Hardware Information ==="
          sysctl -n machdep.cpu.brand_string
          sysctl -n hw.memsize | awk '{print "Memory: " $0/1024/1024/1024 " GB"}'
          echo ""
          echo "=== Disk Space ==="
          df -h | grep -E "Filesystem|/dev/disk"
          echo ""
          echo "=== Available Tools ==="
          command -v git && git --version || echo "git: not found"
          command -v brew && brew --version | head -1 || echo "homebrew: not found"
          command -v python3 && python3 --version || echo "python3: not found"

      - name: Cleanup after run
        if: always()
        run: |
          echo "Performing macOS cleanup..."
          rm -rf $RUNNER_TEMP/* 2>/dev/null || true
          git config --unset-all credential.helper 2>/dev/null || true
          echo "✓ Cleanup completed"

  # Windows self-hosted runner job
  test-windows-runner:
    name: Test Windows Self-Hosted Runner
    needs: validate-runner-config
    runs-on: [self-hosted, Windows, X64]
    if: github.event.inputs.runner_os == 'windows' || github.event.inputs.runner_os == 'all'
    timeout-minutes: 30
    
    env:
      RUNNER_OS: windows
      RUNNER_ARCH: x64
    
    steps:
      - name: Checkout repository (secure)
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          clean: true

      - name: Verify runner environment
        shell: pwsh
        run: |
          Write-Host "Runner OS: $env:RUNNER_OS"
          Write-Host "Runner Name: $env:RUNNER_NAME"
          Write-Host "✓ Running on self-hosted Windows runner"

      - name: Security check - Verify Windows Defender
        shell: pwsh
        run: |
          Write-Host "Checking Windows security settings..."
          Get-MpComputerStatus | Select-Object AntivirusEnabled, RealTimeProtectionEnabled
          Write-Host "✓ Windows security verified"

      - name: Clean workspace (privacy)
        shell: pwsh
        run: |
          Write-Host "Cleaning Windows workspace..."
          Remove-Item -Path ".git/credentials" -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:USERPROFILE\.git-credentials" -ErrorAction SilentlyContinue
          Remove-Item -Path ".env*" -ErrorAction SilentlyContinue
          Get-ChildItem -Path . -Filter "*.pem" -Recurse | Remove-Item -ErrorAction SilentlyContinue
          Get-ChildItem -Path . -Filter "*.key" -Recurse | Remove-Item -ErrorAction SilentlyContinue
          Write-Host "✓ Workspace cleaned"

      - name: System information (Windows)
        shell: pwsh
        run: |
          Write-Host "=== System Information ==="
          Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, OsHardwareAbstractionLayer
          Write-Host ""
          Write-Host "=== CPU Information ==="
          Get-WmiObject Win32_Processor | Select-Object Name, NumberOfCores, NumberOfLogicalProcessors
          Write-Host ""
          Write-Host "=== Memory Information ==="
          $memory = Get-WmiObject Win32_ComputerSystem
          Write-Host "Total Memory: $([math]::Round($memory.TotalPhysicalMemory/1GB, 2)) GB"
          Write-Host ""
          Write-Host "=== Disk Space ==="
          Get-PSDrive -PSProvider FileSystem | Where-Object {$_.Used -gt 0} | Select-Object Name, @{Name="Size(GB)";Expression={[math]::Round($_.Used/1GB + $_.Free/1GB, 2)}}, @{Name="Free(GB)";Expression={[math]::Round($_.Free/1GB, 2)}}
          Write-Host ""
          Write-Host "=== Available Tools ==="
          if (Get-Command git -ErrorAction SilentlyContinue) { git --version } else { Write-Host "git: not found" }
          if (Get-Command python -ErrorAction SilentlyContinue) { python --version } else { Write-Host "python: not found" }
          if (Get-Command docker -ErrorAction SilentlyContinue) { docker --version } else { Write-Host "docker: not found" }

      - name: Cleanup after run
        if: always()
        shell: pwsh
        run: |
          Write-Host "Performing Windows cleanup..."
          Remove-Item -Path "$env:RUNNER_TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
          git config --unset-all credential.helper 2>$null
          Write-Host "✓ Cleanup completed"

  # Summary job
  summary:
    name: Configuration Summary
    needs: [test-linux-runner, test-macos-runner, test-windows-runner]
    if: always()
    # Using self-hosted runner when available for kushmanmb.eth repository
    runs-on: ${{ vars.USE_SELF_HOSTED == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    steps:
      - name: Generate summary
        run: |
          echo "## Self-Hosted Runner Configuration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Helper function to format result
          format_result() {
            case "$1" in
              success) echo "✅ Success" ;;
              failure) echo "❌ Failed" ;;
              cancelled) echo "⚠️ Cancelled" ;;
              skipped) echo "⏭️ Skipped (not selected)" ;;
              *) echo "❓ $1" ;;
            esac
          }
          
          echo "- **Linux Runner**: $(format_result '${{ needs.test-linux-runner.result }}')" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS Runner**: $(format_result '${{ needs.test-macos-runner.result }}')" >> $GITHUB_STEP_SUMMARY
          echo "- **Windows Runner**: $(format_result '${{ needs.test-windows-runner.result }}')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "${{ needs.test-linux-runner.result }}" == "success" ]] || \
             [[ "${{ needs.test-macos-runner.result }}" == "success" ]] || \
             [[ "${{ needs.test-windows-runner.result }}" == "success" ]]; then
            echo "### ✅ At least one runner test completed successfully" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.test-linux-runner.result }}" == "failure" ]] || \
               [[ "${{ needs.test-macos-runner.result }}" == "failure" ]] || \
               [[ "${{ needs.test-windows-runner.result }}" == "failure" ]]; then
            echo "### ❌ One or more runner tests failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ⏭️ All runner tests were skipped" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Security Features Verified" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ No hardcoded credentials in workflows" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Workspace cleanup after each run" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Build isolation verified" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Credential persistence disabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Privacy Features" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Temporary files cleaned up" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Git credentials removed" >> $GITHUB_STEP_SUMMARY
          echo "- ✓ Environment sanitized" >> $GITHUB_STEP_SUMMARY
